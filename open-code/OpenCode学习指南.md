# OpenCode 学习指南

## 目录
- [什么是 OpenCode](#什么是-opencode)
- [核心特性](#核心特性)
- [安装方法](#安装方法)
- [快速开始](#快速开始)
- [用户界面](#用户界面)
- [内置工具系统](#内置工具系统)
- [内置代理模式](#内置代理模式)
- [配置与提供商](#配置与提供商)
- [高级功能](#高级功能)
- [技术架构](#技术架构)
- [常见使用场景](#常见使用场景)
- [最佳实践](#最佳实践)

---

## 什么是 OpenCode

OpenCode 是一个**开源的 AI 编码代理系统**，它让开发者能够通过多种客户端界面与大型语言模型（LLM）进行交互。OpenCode 提供了一个交互式环境，在这个环境中，AI 模型可以：

- 📖 **读取代码库**：理解你的项目结构和代码逻辑
- ✏️ **修改文件**：自动编辑、创建或重构代码
- ⚡ **执行命令**：运行测试、构建项目、安装依赖等
- 🤖 **智能对话**：通过自然语言与 AI 助手交流编程需求

### 设计理念

OpenCode 的核心设计理念包括：
- **无供应商锁定**：完全开源，可在个人基础设施上自托管
- **提供商无关**：支持 75+ 种 LLM 提供商
- **安全可控**：基于权限的工具执行机制
- **多界面支持**：终端、桌面应用、Web、IDE 扩展

---

## 核心特性

### 1. 代理执行（Agentic Execution）

OpenCode 采用迭代循环机制，AI 可以：
1. **分析问题**：理解你的需求和当前代码状态
2. **推理解决方案**：制定实施计划
3. **执行操作**：通过工具系统采取行动
4. **观察结果**：检查执行结果
5. **优化改进**：根据反馈调整方法，直到任务完成

### 2. 提供商无关设计

支持 **75+ 种 LLM 提供商**，包括：

**主流提供商**：
- Anthropic Claude（Claude 3.5 Sonnet、Claude Opus 等）
- OpenAI GPT（GPT-4、GPT-4 Turbo、GPT-3.5 等）
- Google Gemini（Gemini Pro、Gemini Ultra）

**开发者友好选项**：
- GitHub Copilot（可使用现有订阅）
- ChatGPT Plus/Pro 账户
- OpenRouter（聚合多个提供商）

**本地模型**：
- Ollama（支持 Llama、Mistral 等开源模型）
- LM Studio
- 其他 70+ 种提供商

### 3. 语言服务器协议（LSP）支持

提供 **20+ 种编程语言**的语言感知辅助功能：
- 🔍 **诊断信息**：实时错误和警告提示
- 💡 **悬停信息**：查看函数签名和文档
- 🎯 **定义导航**：跳转到变量、函数定义
- 🔗 **引用查找**：查找所有使用位置

### 4. 内置工具系统

AI 可以通过权限控制的工具执行操作：

| 工具名称 | 功能描述 |
|---------|---------|
| `bash` | 执行 Shell 命令（如运行测试、安装依赖） |
| `read` | 读取文件内容 |
| `write` | 创建或替换文件 |
| `edit` | 对文件进行精确修改（打补丁） |
| `grep` | 使用正则表达式搜索代码 |
| `list` | 列出目录内容 |
| `task` | 委托给子代理处理复杂任务 |

---

## 安装方法

### 方法 1：快速安装（推荐）

**macOS / Linux**：
```bash
curl -fsSL https://opencode.ai/install | bash
```

### 方法 2：包管理器安装

**使用 npm**：
```bash
npm install -g opencode-ai
```

**使用 Homebrew（macOS）**：
```bash
brew install anomalyco/tap/opencode
```

**使用 paru（Arch Linux）**：
```bash
paru -S opencode-bin
```

### 方法 3：Docker 运行

```bash
docker run ghcr.io/anomalyco/opencode
```

### 验证安装

安装完成后，运行以下命令验证：
```bash
opencode --version
```

---

## 快速开始

### 第一步：配置提供商

首次使用需要配置 LLM 提供商：

```bash
opencode
```

在终端中输入命令：
```
/connect
```

根据提示选择并配置你的提供商（如 Anthropic、OpenAI 等），输入 API 密钥。

### 第二步：初始化项目

导航到你的项目目录：
```bash
cd /path/to/your/project
```

启动 OpenCode：
```bash
opencode
```

执行初始化命令分析代码库：
```
/init
```

### 第三步：开始使用

现在你可以开始向 AI 提出请求了！例如：

```
帮我创建一个 Express 服务器的基础模板
```

```
重构 src/utils/helper.js 文件，使用更现代的 ES6 语法
```

```
为 User 类添加单元测试
```

---

## 用户界面

OpenCode 提供多种交互界面，满足不同场景需求：

### 1. 终端界面（TUI）

**特点**：
- 原生终端界面
- 60 FPS 渲染
- 实时流式响应
- 适合服务器和命令行爱好者

**启动方式**：
```bash
opencode
```

### 2. 桌面应用

**特点**：
- 基于 Tauri 构建
- 支持 macOS、Windows、Linux
- 原生应用体验
- 图形化界面

**启动方式**：
下载对应平台的安装包后直接运行。

### 3. Web 界面

**特点**：
- 浏览器访问
- 无需安装客户端
- 跨平台兼容

**启动方式**：
```bash
opencode web
```

然后在浏览器中打开显示的地址（通常是 `http://localhost:3000`）。

### 4. IDE 扩展

**特点**：
- 集成到 VS Code 等编辑器
- 无缝工作流
- 编辑器内直接对话

**安装方式**：
在 VS Code 扩展市场搜索 "OpenCode" 并安装。

---

## 内置工具系统

### bash 工具

执行 Shell 命令，适用于：
- 运行测试：`npm test`
- 安装依赖：`npm install lodash`
- 构建项目：`npm run build`
- Git 操作：`git status`、`git commit`

**示例请求**：
```
运行所有测试用例
```

### read 工具

读取文件内容，AI 会自动使用此工具来理解代码。

**示例请求**：
```
读取 src/config.js 文件并解释配置项的含义
```

### write 工具

创建新文件或完全替换文件内容。

**示例请求**：
```
创建一个新的 React 组件 Button.jsx
```

### edit 工具

对现有文件进行精确修改（打补丁方式）。

**示例请求**：
```
在 app.js 中添加错误处理中间件
```

### grep 工具

使用正则表达式搜索代码库。

**示例请求**：
```
查找所有使用 fetch API 的地方
```

### list 工具

列出目录内容，帮助 AI 了解项目结构。

### task 工具

将复杂任务委托给专门的子代理处理。

---

## 内置代理模式

OpenCode 提供两种主要代理模式，可通过 **Tab 键**切换：

### 1. build 代理（构建模式）

**特点**：
- ✅ 完整的开发权限
- ✅ 自动执行工具操作
- ✅ 适合快速开发和迭代

**使用场景**：
- 快速原型开发
- 批量代码重构
- 自动化任务执行

**示例**：
```
使用 build 代理：创建一个完整的 REST API，包括路由、控制器和数据模型
```

### 2. plan 代理（规划模式）

**特点**：
- 📖 只读分析模式
- ⚠️ 修改操作需要手动确认
- 🛡️ 更安全，适合学习和审查

**使用场景**：
- 代码审查和分析
- 学习理解代码库
- 谨慎的修改操作

**示例**：
```
使用 plan 代理：分析当前项目的架构设计，给出改进建议
```

---

## 配置与提供商

### 配置层级

OpenCode 支持多层配置，优先级从高到低：

1. **项目级配置**：`.opencode/config.json`（当前项目）
2. **用户级配置**：`~/.config/opencode/config.json`（全局）
3. **远程配置**：从远程服务器同步

### 配置示例

创建 `.opencode/config.json` 文件：

```json
{
  "provider": "anthropic",
  "model": "claude-3-5-sonnet-20241022",
  "temperature": 0.7,
  "maxTokens": 4096,
  "autoSave": true,
  "theme": "dark"
}
```

### 切换提供商

在对话中使用 `/connect` 命令：
```
/connect
```

然后选择新的提供商并配置。

---

## 高级功能

### 会话持久化

OpenCode 会自动保存会话数据到：
```
~/.local/share/opencode/
```

你可以随时恢复之前的对话和上下文。

### 自定义工具

OpenCode 支持扩展自定义工具，满足特定需求。

**创建自定义工具**（示例）：
```javascript
// .opencode/tools/custom-tool.js
export default {
  name: 'deploy',
  description: '部署应用到生产环境',
  async execute(args) {
    // 实现部署逻辑
    return '部署成功';
  }
};
```

### 多项目管理

OpenCode 可以在不同项目间切换，每个项目维护独立的配置和上下文。

---

## 技术架构

### 核心架构

OpenCode 采用 **客户端-服务器** 模型：

```
┌─────────────┐     HTTP/SSE     ┌──────────────┐
│   客户端    │ ←──────────────→ │  HTTP 服务器 │
│ (TUI/Web/   │                  │  (Hono 框架) │
│  Desktop)   │                  └──────────────┘
└─────────────┘                         ↓
                                 ┌──────────────┐
                                 │  会话存储    │
                                 │  (文件系统)  │
                                 └──────────────┘
```

### 技术栈

| 组件 | 技术 |
|------|------|
| 运行时 | Bun（JavaScript 运行时） |
| UI 框架 | SolidJS（响应式组件） |
| 服务器 | Hono（HTTP 框架） |
| 桌面应用 | Tauri（原生应用框架） |
| 构建系统 | Nix flakes（可复现构建） |
| 提供商集成 | Vercel AI SDK |

### 通信协议

- **HTTP**：客户端与服务器的主要通信协议
- **SSE（Server-Sent Events）**：实时流式响应

---

## 常见使用场景

### 场景 1：创建新功能

**请求**：
```
创建一个用户认证模块，包括注册、登录和 JWT 验证
```

**OpenCode 会**：
1. 分析项目结构
2. 创建必要的文件（routes、controllers、middleware）
3. 安装所需依赖（如 jsonwebtoken、bcrypt）
4. 编写代码和注释
5. 创建测试用例

### 场景 2：代码重构

**请求**：
```
将 src/legacy 目录下的代码重构为 TypeScript，使用现代 async/await 语法
```

**OpenCode 会**：
1. 读取所有相关文件
2. 逐个转换为 TypeScript
3. 更新类型定义
4. 替换回调函数为 async/await
5. 更新导入语句

### 场景 3：Bug 修复

**请求**：
```
修复 API 响应中的内存泄漏问题
```

**OpenCode 会**：
1. 分析代码查找潜在问题
2. 识别未释放的资源
3. 添加适当的清理逻辑
4. 建议性能优化方案

### 场景 4：文档生成

**请求**：
```
为 src/utils 目录下的所有函数生成 JSDoc 注释
```

**OpenCode 会**：
1. 读取所有函数定义
2. 分析参数和返回值
3. 生成详细的 JSDoc 注释
4. 添加使用示例

### 场景 5：测试编写

**请求**：
```
为 UserService 类编写完整的单元测试，覆盖所有方法
```

**OpenCode 会**：
1. 分析 UserService 类结构
2. 创建测试文件
3. 编写各种测试用例（正常、异常、边界）
4. 设置 mock 和 stub
5. 配置测试运行脚本

---

## 最佳实践

### 1. 明确的指令

**✅ 好的请求**：
```
在 src/components 目录创建一个 Pagination 组件，支持页码跳转和每页数量选择
```

**❌ 不好的请求**：
```
帮我弄个分页
```

### 2. 提供上下文

**✅ 好的请求**：
```
我们的项目使用 Vue 3 和 Composition API，请创建一个响应式的搜索组件
```

**❌ 不好的请求**：
```
创建一个搜索组件
```

### 3. 分步骤处理复杂任务

**✅ 好的方式**：
```
第一步：创建数据库模型
第二步：创建 API 路由
第三步：添加验证中间件
```

**❌ 不好的方式**：
```
帮我做一个完整的电商网站
```

### 4. 使用 plan 代理学习

在学习新代码库时，使用 `plan` 代理：
```
切换到 plan 代理，分析项目的目录结构和主要模块
```

### 5. 定期保存和备份

虽然 OpenCode 会自动保存会话，但重要更改前建议：
```bash
git commit -am "保存当前状态"
```

### 6. 利用 LSP 功能

在支持的编程语言中，充分利用语言服务器协议：
```
检查代码中的类型错误
```

```
查找 calculateTotal 函数的所有调用位置
```

### 7. 合理使用权限

- **开发环境**：可以使用 `build` 代理快速迭代
- **生产代码**：使用 `plan` 代理谨慎审查
- **敏感操作**：手动确认工具执行

### 8. 充分利用本地模型

如果有隐私顾虑，可以使用本地 Ollama 模型：
```bash
# 安装 Ollama
curl -fsSL https://ollama.ai/install.sh | sh

# 下载模型
ollama pull codellama

# 在 OpenCode 中配置使用 Ollama
/connect
# 选择 Ollama 提供商
```

---

## 许可证和社区

### 开源许可

OpenCode 采用 **MIT 许可证**，确保：
- ✅ 完全开源
- ✅ 无供应商锁定
- ✅ 可在个人基础设施上完全自托管
- ✅ 自由使用、修改和分发

### 社区参与

**代码仓库**：[github.com/anomalyco/opencode](https://github.com/anomalyco/opencode)

**贡献方式**：
- 报告 Bug
- 提交功能请求
- 贡献代码（Pull Request）
- 改进文档
- 分享使用经验

### 获取帮助

- **GitHub Issues**：报告问题和功能请求
- **讨论区**：参与社区讨论
- **文档**：查看官方文档网站

---

## 总结

OpenCode 是一个强大而灵活的 AI 编码助手，它将 LLM 的强大能力与实际的开发工作流无缝集成。通过：

- 🚀 **简单的安装**：一条命令即可开始
- 🎯 **灵活的配置**：支持 75+ 种 LLM 提供商
- 🛠️ **丰富的工具**：从读取到执行，全方位支持
- 🖥️ **多样的界面**：终端、桌面、Web、IDE
- 🔐 **安全可控**：基于权限的执行机制
- 🌐 **完全开源**：无供应商锁定

OpenCode 能够显著提升你的开发效率，让 AI 成为你的编程伙伴。

---

## 附录：常用命令速查

| 命令 | 功能 |
|------|------|
| `opencode` | 启动终端界面 |
| `opencode web` | 启动 Web 界面 |
| `/connect` | 配置/切换 LLM 提供商 |
| `/init` | 初始化/分析代码库 |
| `/help` | 查看帮助信息 |
| `Tab` | 切换代理模式（build/plan） |
| `Ctrl+C` | 停止当前操作 |
| `/exit` 或 `/quit` | 退出 OpenCode |

---

**开始你的 OpenCode 之旅吧！** 🎉
